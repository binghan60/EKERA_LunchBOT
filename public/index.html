<!DOCTYPE html>
<html lang="zh-tw">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Group Setting CRUD</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

        <script>
            // API 路徑集中管理
            const API_BASE = 'https://ekera-bot.vercel.app/group-settings/';
            const API_ROUTES = {
                CREATE: API_BASE,
                READ: (id) => `${API_BASE}/${id}`,
                UPDATE: (id) => `${API_BASE}/${id}`,
                DELETE: (id) => `${API_BASE}/${id}`,
            };

            // DOM 邏輯 & CRUD
            window.addEventListener('DOMContentLoaded', () => {
                const officeList = document.getElementById('officeList');

                // 建立目前地點選單
                function renderOfficeOptions(options) {
                    const select = document.getElementById('currentOffice');
                    select.innerHTML = '';
                    options.forEach((opt) => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        select.appendChild(option);
                    });
                }

                const clearList = () => (officeList.innerHTML = '');
                const getOfficeArray = () => Array.from(officeList.children).map((li) => li.textContent);

                // 加入新地點選項
                document.getElementById('addOption').onclick = () => {
                    const newOffice = document.getElementById('newOffice').value.trim();
                    if (newOffice) {
                        const li = document.createElement('li');
                        li.textContent = newOffice;
                        li.className = 'ml-4 list-disc';
                        officeList.appendChild(li);
                        document.getElementById('newOffice').value = '';
                    }
                };

                // Create
                document.getElementById('createBtn').onclick = async () => {
                    const groupId = document.getElementById('groupId').value.trim();
                    const currentOffice = document.getElementById('currentOffice').value;
                    const officeOption = getOfficeArray();
                    if (!groupId || !currentOffice) return alert('請輸入完整資料');

                    try {
                        await axios.post(API_ROUTES.CREATE, { groupId, currentOffice, officeOption });
                        alert('已新增群組設定');
                    } catch (err) {
                        alert(err.response?.data || '新增失敗');
                    }
                };

                // Read
                document.getElementById('readBtn').onclick = async () => {
                    const groupId = document.getElementById('groupId').value.trim();
                    if (!groupId) return alert('請輸入群組 ID');

                    try {
                        const res = await axios.get(API_ROUTES.READ(groupId));
                        const { currentOffice, officeOption } = res.data;
                        renderOfficeOptions(officeOption);
                        document.getElementById('currentOffice').value = currentOffice;
                        clearList();
                        officeOption.forEach((opt) => {
                            const li = document.createElement('li');
                            li.textContent = opt;
                            li.className = 'ml-4 list-disc';
                            officeList.appendChild(li);
                        });
                    } catch (err) {
                        alert(err.response?.data || '讀取失敗');
                    }
                };

                // Update
                document.getElementById('updateBtn').onclick = async () => {
                    const groupId = document.getElementById('groupId').value.trim();
                    const currentOffice = document.getElementById('currentOffice').value;
                    const officeOption = getOfficeArray();
                    if (!groupId || !currentOffice) return alert('請輸入完整資料');

                    try {
                        await axios.put(API_ROUTES.UPDATE(groupId), { currentOffice, officeOption });
                        alert('已更新群組設定');
                    } catch (err) {
                        alert(err.response?.data || '更新失敗');
                    }
                };

                // Delete
                document.getElementById('deleteBtn').onclick = async () => {
                    const groupId = document.getElementById('groupId').value.trim();
                    if (!groupId) return alert('請輸入群組 ID');

                    if (confirm(`確定要刪除群組 ${groupId} 的設定？`)) {
                        try {
                            await axios.delete(API_ROUTES.DELETE(groupId));
                            alert('已刪除群組設定');
                        } catch (err) {
                            alert(err.response?.data || '刪除失敗');
                        }
                    }
                };

                // 自動從 querystring 帶出群組 ID
                const params = new URLSearchParams(window.location.search);
                const autoGroupId = params.get('groupId');
                if (autoGroupId) {
                    document.getElementById('groupId').value = autoGroupId;
                    document.getElementById('readBtn').click(); // 自動點擊讀取按鈕
                }
            });
        </script>
    </head>
    <body class="bg-gray-100 p-6">
        <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow space-y-6">
            <h1 class="text-xl font-bold text-blue-600">Group Setting 管理介面</h1>

            <div>
                <label class="block mb-1">群組 ID</label>
                <input id="groupId" class="w-full border p-2 rounded" type="text" />
            </div>

            <div>
                <label class="block mb-1">目前地點</label>
                <select id="currentOffice" class="w-full border p-2 rounded"></select>
            </div>

            <div>
                <label class="block mb-1">地點選項</label>
                <ul id="officeList" class="mb-2 text-gray-700"></ul>
                <div class="flex gap-2">
                    <input id="newOffice" class="flex-1 border p-2 rounded" placeholder="輸入新地點" />
                    <button id="addOption" class="bg-blue-500 text-white px-4 py-2 rounded">加入</button>
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                <button id="createBtn" class="bg-green-500 text-white px-4 py-2 rounded">新增</button>
                <button id="readBtn" class="bg-yellow-500 text-white px-4 py-2 rounded">讀取</button>
                <button id="updateBtn" class="bg-blue-500 text-white px-4 py-2 rounded">更新</button>
                <button id="deleteBtn" class="bg-red-500 text-white px-4 py-2 rounded">刪除</button>
            </div>
        </div>
    </body>
</html>
